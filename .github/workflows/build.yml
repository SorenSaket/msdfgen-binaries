name: Build msdfgen

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  schedule:
    # Check for msdfgen updates daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      msdfgen_ref:
        description: 'msdfgen git ref (tag like v1.13, or master for latest)'
        required: false
        default: 'v1.13'
      create_release:
        description: 'Create a GitHub release'
        type: boolean
        required: false
        default: false
      force_build:
        description: 'Force build even if no changes'
        type: boolean
        required: false
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  VCPKG_COMMIT: "40c89449f0ccce12d21f8a906639f6c2c649b9e7"
  DEFAULT_VERSION: "v1.13"

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      msdfgen_ref: ${{ steps.resolve.outputs.msdfgen_ref }}
      msdfgen_sha: ${{ steps.resolve.outputs.msdfgen_sha }}
      version: ${{ steps.resolve.outputs.version }}
      is_release: ${{ steps.resolve.outputs.is_release }}
      should_build: ${{ steps.resolve.outputs.should_build }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Resolve version and check for changes
        id: resolve
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cd msdfgen
          git fetch --tags origin
          git fetch origin master

          SHOULD_BUILD="true"

          if [ -n "${{ github.event.inputs.msdfgen_ref }}" ]; then
            # Manual trigger
            MSDFGEN_REF="${{ github.event.inputs.msdfgen_ref }}"
            if [[ "$MSDFGEN_REF" == v* ]]; then
              VERSION="$MSDFGEN_REF"
            else
              VERSION="dev-$(date +%Y%m%d)"
            fi
            IS_RELEASE="${{ github.event.inputs.create_release }}"
            if [ "${{ github.event.inputs.force_build }}" != "true" ] && [ "$IS_RELEASE" != "true" ]; then
              # Check if we need to build
              MSDFGEN_SHA=$(git rev-parse "$MSDFGEN_REF")
            fi
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Tag push - always build
            VERSION="${{ github.ref_name }}"
            MSDFGEN_REF="$VERSION"
            IS_RELEASE="true"
          elif [ "${{ github.event_name }}" == "schedule" ]; then
            # Scheduled - check if msdfgen master has new commits
            MSDFGEN_REF="master"
            VERSION="dev-$(date +%Y%m%d)"
            IS_RELEASE="false"

            # Get current master SHA
            MSDFGEN_SHA=$(git rev-parse origin/master)

            # Get the SHA from the last dev-latest release
            cd ..
            LAST_SHA=""
            if gh release view dev-latest --json body -q '.body' 2>/dev/null | grep -oP 'msdfgen@\K[a-f0-9]+' > /tmp/last_sha; then
              LAST_SHA=$(cat /tmp/last_sha)
            fi

            echo "Current msdfgen SHA: $MSDFGEN_SHA"
            echo "Last built SHA: $LAST_SHA"

            if [ "$MSDFGEN_SHA" == "$LAST_SHA" ]; then
              echo "No changes in msdfgen since last build. Skipping."
              SHOULD_BUILD="false"
            else
              echo "msdfgen has new commits. Building."
            fi
            cd msdfgen
          else
            # Push to main - build latest stable
            MSDFGEN_REF="${DEFAULT_VERSION}"
            VERSION="${DEFAULT_VERSION}"
            IS_RELEASE="false"
          fi

          # Get the SHA for the ref we're building
          MSDFGEN_SHA=$(git rev-parse "$MSDFGEN_REF" 2>/dev/null || git rev-parse "origin/$MSDFGEN_REF" 2>/dev/null || echo "")

          echo "msdfgen_ref=${MSDFGEN_REF}" >> $GITHUB_OUTPUT
          echo "msdfgen_sha=${MSDFGEN_SHA}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "is_release=${IS_RELEASE}" >> $GITHUB_OUTPUT
          echo "should_build=${SHOULD_BUILD}" >> $GITHUB_OUTPUT

          echo "Summary:"
          echo "  Ref: ${MSDFGEN_REF}"
          echo "  SHA: ${MSDFGEN_SHA}"
          echo "  Version: ${VERSION}"
          echo "  Is Release: ${IS_RELEASE}"
          echo "  Should Build: ${SHOULD_BUILD}"

  build-macos:
    needs: prepare
    if: needs.prepare.outputs.should_build == 'true'
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm64
            triplet: arm64-osx
            runner: macos-15
          - arch: x64
            triplet: x64-osx
            runner: macos-15-intel
    runs-on: ${{ matrix.runner }}
    env:
      VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 1

      - name: Export GitHub Actions cache variables
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Checkout msdfgen version
        run: |
          cd msdfgen
          git fetch --tags origin
          git checkout ${{ needs.prepare.outputs.msdfgen_ref }}
          git log -1 --oneline

      - name: Install dependencies
        run: |
          # Only install if not present to avoid "already installed" noise
          for pkg in cmake ninja pkg-config; do
            brew list $pkg &>/dev/null || brew install $pkg
          done

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT }}
          vcpkgDirectory: '${{ github.workspace }}/vcpkg'
          runVcpkgInstall: false

      - name: Configure
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake \
            -DVCPKG_TARGET_TRIPLET=${{ matrix.triplet }} \
            -DVCPKG_OVERLAY_TRIPLETS=${{ github.workspace }}/triplets \
            -G Ninja \
            -DMSDFGEN_USE_SKIA=ON \
            -DBUILD_SHARED_LIBS=ON
        env:
          VCPKG_DEFAULT_TRIPLET: ${{ matrix.triplet }}

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Package
        run: |
          mkdir -p artifacts
          V="${{ needs.prepare.outputs.version }}"
          find build -name "*.dylib" -exec cp {} artifacts/ \;
          cd artifacts
          for f in *.dylib; do
            [ -f "$f" ] && mv "$f" "${f%.dylib}-${V}-macos-${{ matrix.arch }}.dylib"
          done
          ls -la

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: artifacts/
          retention-days: 7
          compression-level: 6

  build-windows:
    needs: prepare
    if: needs.prepare.outputs.should_build == 'true'
    timeout-minutes: 60
    runs-on: windows-latest
    env:
      VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 1

      - name: Export GitHub Actions cache variables
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Checkout msdfgen version
        shell: bash
        run: |
          cd msdfgen
          git fetch --tags origin
          git checkout ${{ needs.prepare.outputs.msdfgen_ref }}
          git log -1 --oneline

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT }}
          vcpkgDirectory: '${{ github.workspace }}/vcpkg'
          runVcpkgInstall: false

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Configure
        run: |
          cmake -B build `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake `
            -DVCPKG_TARGET_TRIPLET=x64-windows-static-md `
            -G Ninja `
            -DMSDFGEN_USE_SKIA=ON `
            -DBUILD_SHARED_LIBS=ON
        env:
          VCPKG_DEFAULT_TRIPLET: x64-windows-static-md

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Package
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts
          $V = "${{ needs.prepare.outputs.version }}"
          Get-ChildItem -Path build -Recurse -Include *.dll | ForEach-Object {
            Copy-Item $_.FullName -Destination "artifacts/$($_.BaseName)-${V}-windows-x64.dll"
          }
          Get-ChildItem -Path build -Recurse -Include *.lib | ForEach-Object {
            Copy-Item $_.FullName -Destination "artifacts/$($_.BaseName)-${V}-windows-x64.lib"
          }
          Get-ChildItem artifacts/

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: artifacts/
          retention-days: 7
          compression-level: 6

  build-linux:
    needs: prepare
    if: needs.prepare.outputs.should_build == 'true'
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            triplet: x64-linux
            runner: ubuntu-22.04
          - arch: arm64
            triplet: arm64-linux
            runner: ubuntu-24.04-arm
    runs-on: ${{ matrix.runner }}
    env:
      VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build pkg-config \
            libgl1-mesa-dev libglu1-mesa-dev libx11-dev libxrandr-dev \
            libxinerama-dev libxcursor-dev libxi-dev libfontconfig1-dev

      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 1

      - name: Export GitHub Actions cache variables
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Checkout msdfgen version
        run: |
          cd msdfgen
          git fetch --tags origin
          git checkout ${{ needs.prepare.outputs.msdfgen_ref }}
          git log -1 --oneline

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT }}
          vcpkgDirectory: '${{ github.workspace }}/vcpkg'
          runVcpkgInstall: false

      - name: Configure
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake \
            -DVCPKG_TARGET_TRIPLET=${{ matrix.triplet }} \
            -DVCPKG_OVERLAY_TRIPLETS=${{ github.workspace }}/triplets \
            -G Ninja \
            -DMSDFGEN_USE_SKIA=ON \
            -DBUILD_SHARED_LIBS=ON
        env:
          VCPKG_DEFAULT_TRIPLET: ${{ matrix.triplet }}

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Package
        run: |
          mkdir -p artifacts
          V="${{ needs.prepare.outputs.version }}"
          find build -name "*.so*" -type f -exec cp {} artifacts/ \;
          cd artifacts
          for f in *.so*; do
            [ -f "$f" ] && base=$(echo "$f" | sed 's/\.so.*//') && mv "$f" "${base}-${V}-linux-${{ matrix.arch }}.so"
          done
          ls -la

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.arch }}
          path: artifacts/
          retention-days: 7
          compression-level: 6

  upload-headers:
    needs: prepare
    if: needs.prepare.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Upload header
        uses: actions/upload-artifact@v4
        with:
          name: headers
          path: src/msdfgen_c_api.h
          retention-days: 7

  release:
    needs: [prepare, build-macos, build-windows, build-linux, upload-headers]
    if: needs.prepare.outputs.is_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Package per platform
        run: |
          V="${{ needs.prepare.outputs.version }}"
          mkdir -p release
          for platform in macos-arm64 macos-x64 windows-x64 linux-x64 linux-arm64; do
            if [ -d "artifacts/$platform" ]; then
              cd "artifacts/$platform"
              zip -r "../../release/msdfgen-binaries-${V}-${platform}.zip" .
              cd ../..
            fi
          done
          # Package headers separately
          if [ -d "artifacts/headers" ]; then
            cd artifacts/headers
            zip -r "../../release/msdfgen-binaries-${V}-headers.zip" .
            cd ../..
          fi
          ls -la release/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.version }}
          name: msdfgen ${{ needs.prepare.outputs.version }}
          body: |
            Pre-built msdfgen ${{ needs.prepare.outputs.version }} binaries with Skia geometry preprocessing.

            ## Libraries
            | Library | Description |
            |---------|-------------|
            | `msdfgen-core` | Core MSDF generation |
            | `msdfgen-ext` | Extensions (FreeType, TinyXML2, libpng, Skia) |
            | `msdfgen_c` | C API wrapper for FFI/P/Invoke |

            ## Platforms
            - macOS arm64 (Apple Silicon)
            - macOS x64 (Intel)
            - Windows x64
            - Linux x64
            - Linux arm64

            See [README](https://github.com/${{ github.repository }}) for usage.
          files: release/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-dev:
    needs: [prepare, build-macos, build-windows, build-linux, upload-headers]
    if: needs.prepare.outputs.is_release != 'true' && needs.prepare.outputs.should_build == 'true' && github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Package per platform
        run: |
          mkdir -p release
          for platform in macos-arm64 macos-x64 windows-x64 linux-x64 linux-arm64; do
            if [ -d "artifacts/$platform" ]; then
              cd "artifacts/$platform"
              zip -r "../../release/msdfgen-binaries-dev-latest-${platform}.zip" .
              cd ../..
            fi
          done
          # Package headers separately
          if [ -d "artifacts/headers" ]; then
            cd artifacts/headers
            zip -r "../../release/msdfgen-binaries-dev-latest-headers.zip" .
            cd ../..
          fi
          ls -la release/

      - name: Update dev release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: dev-latest
          name: Development Build (Latest)
          body: |
            Latest development build from msdfgen master branch.

            **Built:** ${{ needs.prepare.outputs.version }}
            **Source:** msdfgen@${{ needs.prepare.outputs.msdfgen_sha }}
          files: release/*
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
